name: Comprehensive MCU Setup Test

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥ã®æœ9æ™‚ï¼ˆJSTï¼‰ã«å®šæœŸå®Ÿè¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–'
        required: false
        default: 'false'

env:
  TERM: xterm-256color

jobs:
  # Job 1: æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã¨é™çš„è§£æž
  lint-and-validate:
    name: ðŸ” æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ & é™çš„è§£æž
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ðŸ› ï¸ ShellCheckã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
    
    - name: ðŸ” Bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ ==="
        for script in *.sh tests/*.sh; do
          if [[ -f "$script" ]]; then
            echo "Checking: $script"
            bash -n "$script"
          fi
        done
    
    - name: ðŸ“Š ShellChecké™çš„è§£æž
      run: |
        echo "=== ShellCheckè§£æž ==="
        shellcheck -x *.sh tests/*.sh || true
    
    - name: âœ… æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
      run: |
        chmod +x tests/validate_scripts.sh
        ./tests/validate_scripts.sh

  # Job 2: Ubuntu 24.04ã§ã®ãƒ•ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
  test-ubuntu-2404:
    name: ðŸš€ Ubuntu 24.04 ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-24.04
    needs: lint-and-validate
    
    steps:
    - name: ðŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ðŸ“Š ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
      run: |
        echo "=== System Information ==="
        lsb_release -a
        echo "CPU: $(nproc) cores"
        echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Disk: $(df -h / | tail -1 | awk '{print $4}' ) free"
    
    - name: ðŸ”§ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ä»˜ä¸Ž
      run: chmod +x *.sh
    
    - name: ðŸš€ Bootstrapå®Ÿè¡Œ
      run: |
        ./bootstrap_mcu_prereq.sh
        
    - name: ðŸŽ¯ ãƒ¡ã‚¤ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ
      run: |
        ./setup_mcu_env.sh
      timeout-minutes: 30
    
    - name: âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¤œè¨¼
      run: |
        echo "=== æ¤œè¨¼çµæžœ ==="
        echo "âœ“ GCC: $(gcc --version | head -n1)"
        echo "âœ“ Git: $(git --version)"
        echo "âœ“ CMake: $(cmake --version | head -n1)"
        echo "âœ“ Python3: $(python3 --version)"
        echo "âœ“ ARM GCC: $(arm-none-eabi-gcc --version | head -n1 || echo 'Not found')"
        echo "âœ“ RISC-V GCC: $(riscv-none-elf-gcc --version 2>&1 | head -n1 || riscv64-unknown-elf-gcc --version 2>&1 | head -n1 || echo 'Not found')"
        echo "âœ“ OpenOCD: $(openocd --version 2>&1 | head -n1 || echo 'Not found')"
        echo "âœ“ Arduino CLI: $(arduino-cli version 2>&1 || echo 'Not found')"
        echo "âœ“ PlatformIO: $(pio --version 2>&1 || echo 'Not found')"
    
    - name: ðŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: installation-logs-ubuntu-2404
        path: |
          troubleshoot/
          *.log

  # Job 3: Dockerã‚³ãƒ³ãƒ†ãƒŠã§ã®ãƒ†ã‚¹ãƒˆ
  test-docker:
    name: ðŸ³ Dockerã‚³ãƒ³ãƒ†ãƒŠãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
    - name: ðŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ðŸ³ Dockerãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰
      run: |
        chmod +x tests/test_scripts_docker.sh
        # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¦å®Ÿè¡Œ
        sed -i 's/docker run --rm -it/docker run --rm/g' tests/test_scripts_docker.sh
        ./tests/test_scripts_docker.sh

  # Job 4: Ubuntu 22.04ã§ã®äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
  test-ubuntu-2204:
    name: ðŸ”„ Ubuntu 22.04 äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-22.04
    needs: lint-and-validate
    continue-on-error: true
    
    steps:
    - name: ðŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ðŸ”§ å®Ÿè¡Œæ¨©é™ä»˜ä¸Ž
      run: chmod +x *.sh
    
    - name: ðŸš€ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
      run: |
        ./bootstrap_mcu_prereq.sh
        ./setup_mcu_env.sh || true
    
    - name: ðŸ“Š çµæžœç¢ºèª
      run: |
        echo "äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Œäº†"
        echo "ä¸€éƒ¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯22.04ã§ã¯åˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"

  # Job 5: ãƒžãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆè¤‡æ•°ç’°å¢ƒï¼‰
  matrix-test:
    name: ðŸ”„ ãƒžãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ
    runs-on: ${{ matrix.os }}
    needs: lint-and-validate
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, ubuntu-latest]
        include:
          - os: ubuntu-20.04
            name: "Ubuntu 20.04 LTS"
          - os: ubuntu-22.04
            name: "Ubuntu 22.04 LTS"
          - os: ubuntu-latest
            name: "Ubuntu Latest"
    
    steps:
    - name: ðŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ðŸ“Š OSæƒ…å ±
      run: |
        echo "Testing on: ${{ matrix.name }}"
        lsb_release -a
    
    - name: ðŸ§ª ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ†ã‚¹ãƒˆ
      run: |
        chmod +x tests/test_dry_run.sh
        ./tests/test_dry_run.sh

  # Job 6: æˆåŠŸçŽ‡ãƒ¬ãƒãƒ¼ãƒˆ
  report-summary:
    name: ðŸ“Š ãƒ†ã‚¹ãƒˆã‚µãƒžãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [test-ubuntu-2404, test-docker, test-ubuntu-2204, matrix-test]
    if: always()
    
    steps:
    - name: ðŸ“‹ çµæžœã‚µãƒžãƒªãƒ¼ä½œæˆ
      run: |
        echo "# MCU Setup Scripts Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Ubuntu 24.04 Full Test | ${{ needs.test-ubuntu-2404.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Test | ${{ needs.test-docker.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Ubuntu 22.04 Compatibility | ${{ needs.test-ubuntu-2204.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Generated at: $(date)" >> $GITHUB_STEP_SUMMARY 